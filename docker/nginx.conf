# =============================================================================
# Nginx Configuration for Multi-location Looking Glass Speed Test Server
# Serves static test files for network speed testing
# =============================================================================

# Run as non-privileged user
user nginx;
worker_processes auto;
pid /run/nginx/nginx.pid;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;

    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip compression (disabled for binary test files)
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript 
               application/rss+xml application/atom+xml image/svg+xml;

    # Rate limiting zone (optional, protect from abuse)
    limit_req_zone $binary_remote_addr zone=speedtest:10m rate=10r/m;

    # Speed test file server
    server {
        listen 8080 default_server;
        listen [::]:8080 default_server;
        
        server_name _;
        root /var/www;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # CORS headers for cross-origin downloads
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Accept-Encoding" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range" always;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # Speed test files location
        location /speedtest {
            alias /var/www/speedtest;
            
            # Apply rate limiting (10 requests per minute per IP)
            limit_req zone=speedtest burst=5 nodelay;

            # Disable gzip for binary files (important for accurate speed tests)
            gzip off;

            # Enable range requests for resume support
            add_header Accept-Ranges bytes always;

            # Cache control - no caching for speed test files
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            expires -1;

            # Content disposition for downloads
            if ($request_filename ~* ^.+\.(bin)$) {
                add_header Content-Disposition "attachment" always;
            }

            # Index for directory listing (optional)
            autoindex on;
            autoindex_exact_size on;
            autoindex_format json;
        }

        # Favicon
        location = /favicon.ico {
            log_not_found off;
            access_log off;
            return 204;
        }

        # Robots.txt
        location = /robots.txt {
            log_not_found off;
            access_log off;
            return 200 "User-agent: *\nDisallow: /speedtest/\n";
            add_header Content-Type text/plain;
        }

        # Default location - show simple info page
        location / {
            default_type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Speed Test Server</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        h1 { color: #1a202c; }
        a { color: #3182ce; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .files { list-style: none; padding: 0; }
        .files li { padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
        .size { color: #718096; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>üöÄ Speed Test Server</h1>
    <p>Download test files to measure your network speed:</p>
    <ul class="files">
        <li><a href="/speedtest/10MB.bin">‚¨áÔ∏è 10 MB Test File</a> <span class="size">(10 MB)</span></li>
        <li><a href="/speedtest/100MB.bin">‚¨áÔ∏è 100 MB Test File</a> <span class="size">(100 MB)</span></li>
        <li><a href="/speedtest/1GB.bin">‚¨áÔ∏è 1 GB Test File</a> <span class="size">(1 GB)</span></li>
    </ul>
    <p><a href="/">‚Üê Back to Looking Glass</a></p>
</body>
</html>';
        }
    }
}
